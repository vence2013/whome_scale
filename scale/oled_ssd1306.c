#include "oled_ssd1306.h"
#include "sl_i2cspm_instances.h"


#define OLED_I2C_ADDRESS                                         0X78


void delay(int x)
{
  int i, j;

  for (i = 0; i < x; i++)
    for (j = 0; j < 1000; j++) ;
}


/* cmd: 命令
 * para: 参数
 * len : 参数字节数
 */
int i2c_cmd(char cmd, char* para, char len)
{
  uint8_t i, bytes[10], ctl[] = {0};
  I2C_TransferSeq_TypeDef seq = {
      .addr  = OLED_I2C_ADDRESS,
      .flags = I2C_FLAG_WRITE_WRITE,
      .buf   = {
          {.data = ctl,   .len = 1},
          {.data = bytes, .len = 1+len}
      }
  };

  bytes[0] = cmd;
  for (i = 0; i < len; i++)
    bytes[i+1] = para[i];

  return (int)I2CSPM_Transfer(sl_i2cspm_oled_i2c, &seq);
}

int i2c_data(char dat)
{
  uint8_t ctl[] = {0x40}, bytes[] = {0};
  I2C_TransferSeq_TypeDef seq = {
      .addr  = OLED_I2C_ADDRESS,
      .flags = I2C_FLAG_WRITE_WRITE,
      .buf   = {
          {.data = ctl,   .len = 1},
          {.data = bytes, .len = 1}
      }
  };

  bytes[0] = dat;
  return (int)I2CSPM_Transfer(sl_i2cspm_oled_i2c, &seq);
}


void ssd1306_clear(unsigned char val)
{
  int i, j;

  for (i = 0; i < 8; i++) // page
  {
      i2c_cmd(0xb0+i, 0, 0);  // 设置页地址
      i2c_cmd(0x00, 0, 0);
      i2c_cmd(0x10, 0, 0);

      for (j = 0; j < 128; j++)
        i2c_data(val);
  }
}

void ssd1306_set_pos(char x, char y)
{
  i2c_cmd(0xb0+y, 0, 0);  // 设置页地址
  i2c_cmd(0x10 + ((x>>4)&0x0f), 0, 0);
  i2c_cmd(0x00 + (x&0x0f), 0, 0);
}

unsigned char font8x16[][16] =
{
  {0x00,0xC0,0x30,0x10,0x10,0x30,0xE0,0x00,0x00,0x07,0x0C,0x08,0x08,0x0C,0x03,0x00},/*"0",0*/
  {0x00,0x20,0x20,0x10,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00},/*"1",1*/
  {0x00,0x20,0x10,0x10,0x10,0x90,0xE0,0x00,0x00,0x0C,0x0A,0x0A,0x09,0x08,0x08,0x00},/*"2",2*/
  {0x00,0x20,0x90,0x90,0x90,0x60,0x00,0x00,0x00,0x04,0x08,0x08,0x08,0x07,0x00,0x00},/*"3",3*/
  {0x00,0x00,0x80,0x40,0x20,0xF0,0x00,0x00,0x02,0x03,0x02,0x02,0x02,0x0F,0x02,0x00},/*"4",4*/
  {0x00,0xF0,0x90,0x90,0x90,0x90,0x10,0x00,0x00,0x00,0x08,0x08,0x08,0x0D,0x07,0x00},/*"5",5*/
  {0x00,0xC0,0x20,0x90,0x90,0x90,0x00,0x00,0x00,0x07,0x0D,0x08,0x08,0x08,0x07,0x00},/*"6",6*/
  {0x10,0x10,0x10,0x10,0x90,0x70,0x10,0x00,0x00,0x00,0x0C,0x03,0x00,0x00,0x00,0x00},/*"7",7*/
  {0x00,0x60,0x90,0x90,0x90,0x90,0x60,0x00,0x00,0x07,0x08,0x08,0x08,0x08,0x07,0x00},/*"8",8*/
  {0x00,0xE0,0x10,0x10,0x10,0x30,0xE0,0x00,0x00,0x00,0x09,0x09,0x09,0x05,0x03,0x00},/*"9",9*/
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x00,0x00,0x00,0x00,0x00},/*".",10*/
  {0x00,0xF0,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x0F,0x02,0x05,0x0D,0x08,0x00,0x00},/*"k",11*/
  {0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x07,0x28,0x28,0x28,0x28,0x1F,0x00},/*"g",12*/
};

void ssd1306_draw_char(char x, char y, char ch)
{
  int i, idx;

  if ((ch >= '0') && (ch <= '9')) idx = ch - '0';
  else if (ch == '.') idx = 10;
  else if (ch == 'k') idx = 11;
  else if (ch == 'g') idx = 12;
  else return ;

  ssd1306_set_pos(x, y);
  for (i = 0; i < 8; i++)
    i2c_data(font8x16[idx][i]);
  ssd1306_set_pos(x, y + 1);
  for (i = 0; i < 8; i++)
    i2c_data(font8x16[idx][i+8]);
}

void ssd1306_draw_text(char x, char y, char* str, char len)
{
  int i;

  for (i = 0; i < len; i++)
    ssd1306_draw_char(x + i*8, y, str[i]);
}

unsigned char font16x32[][32] =
{
    {0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xF8,0xFE,0x07,0x01,0x00,0x00,0x00,0x00,0x01,0x0F,0xFE,0xF0,0x00,0x00},
    {0x00,0x0F,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x0C,0x08,0x08,0x08,0x08,0x06,0x07,0x01,0x00,0x00,0x00},/*"0",0*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x0F,0x0F,0x08,0x08,0x08,0x08,0x00,0x00,0x00},/*"1",1*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x1E,0x3F,0x10,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0x7F,0x1C,0x00,0x00},
    {0x00,0x00,0x00,0x00,0xC0,0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00,0x80,0x00,0x00,0x00,0x0C,0x0E,0x0D,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0E,0x01,0x00,0x00},/*"2",2*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x0F,0x08,0x00,0x00,0x00,0x00,0x80,0xC3,0x7F,0x3E,0x00,0x00,0x00},
    {0x00,0x00,0x80,0xC0,0x80,0x00,0x01,0x01,0x01,0x02,0x02,0x1C,0xFC,0xF0,0x00,0x00,0x00,0x00,0x03,0x07,0x0D,0x08,0x08,0x08,0x08,0x08,0x0C,0x07,0x03,0x00,0x00,0x00},/*"3",3*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x30,0x08,0x06,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x30,0x2C,0x26,0x21,0x20,0x20,0x20,0x20,0xFF,0xFF,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x0F,0x0F,0x0C,0x08,0x08,0x00,0x00},/*"4",4*/
    {0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x01,0x81,0x81,0xC1,0xC1,0xC1,0x81,0x81,0x01,0x00,0x00,0x00},
    {0x00,0x00,0xC0,0xC3,0x81,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0xFF,0xFC,0x00,0x00,0x00,0x00,0x03,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x0C,0x07,0x03,0x00,0x00,0x00},/*"5",5*/
    {0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0x07,0x81,0x80,0xC0,0xC0,0xC0,0x80,0x87,0x03,0x00,0x00,0x00},
    {0x00,0x1F,0xFF,0xFF,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFE,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0C,0x08,0x08,0x08,0x08,0x08,0x06,0x03,0x01,0x00,0x00},/*"6",6*/
    {0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x0F,0x03,0x01,0x01,0x01,0x01,0x01,0xC1,0x31,0x0D,0x03,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0x0F,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"7",7*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x7F,0xE1,0xC0,0x80,0x80,0x00,0x00,0x80,0xC1,0x7F,0x1C,0x00,0x00},
    {0x00,0xE0,0xF8,0x0C,0x06,0x03,0x01,0x03,0x03,0x07,0x0E,0x1C,0xF8,0xF0,0x00,0x00,0x00,0x00,0x03,0x06,0x0C,0x08,0x08,0x08,0x08,0x08,0x08,0x04,0x03,0x01,0x00,0x00},/*"8",8*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0x8F,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x87,0xFE,0xF8,0x00,0x00},
    {0x00,0x00,0x03,0x07,0x0C,0x0C,0x08,0x08,0x08,0x04,0x02,0xF1,0xFF,0x1F,0x00,0x00,0x00,0x00,0x02,0x07,0x0F,0x08,0x08,0x08,0x08,0x04,0x07,0x03,0x00,0x00,0x00,0x00},/*"9",9*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x0E,0x0E,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*".",10*/
    {0x00,0x00,0x80,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x40,0xC0,0x40,0x40,0x40,0x00,0x00},
    {0x00,0x00,0x00,0xFF,0xFF,0x30,0x18,0x1C,0x7E,0xE3,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x0F,0x0F,0x08,0x00,0x00,0x00,0x00,0x0B,0x0F,0x0C,0x08,0x08,0x00},/*"k",11*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x40,0x40,0x40,0x40,0x80,0x80,0x40,0xC0,0xC0,0x00},
    {0x00,0x00,0x00,0x9F,0x71,0x40,0x40,0x40,0x40,0x40,0x31,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0xCF,0x87,0x02,0x06,0x06,0x06,0x06,0x06,0x84,0xFC,0x78,0x00,0x00},/*"g",12*/
};

void ssd1306_draw_char2(char x, char y, char ch)
{
  int i, j, idx;

  if ((ch >= '0') && (ch <= '9')) idx = (ch - '0') * 2;
  else if (ch == '.') idx = 20;
  else if (ch == 'k') idx = 22;
  else if (ch == 'g') idx = 24;
  else return ;

  for (i = 0; i < 4; i++)
  {
      ssd1306_set_pos(x, y + i);
      for (j = 0; j < 16; j++)
      {
          int ridx = i / 2;
          int hidx = i % 2;
          i2c_data(font16x32[idx + ridx][hidx*16 + j]);
      }
  }
}

void ssd1306_draw_text2(char x, char y, char* str, char len)
{
  int i;

  for (i = 0; i < len; i++)
    ssd1306_draw_char2(x + i*16, y, str[i]);
}

/* 1. 配置驱动的行数
 * 2. 测试打开整个显示屏
 * */
void cfg_all_on( void )
{
  char para[4];

  // 设置驱动的路数，0.91寸的显示屏最大好像是32
  para[0] = 0x20;
  i2c_cmd(0XA8, para, 1);

  // 不管显示内存RAM的内容，直接打开整个显示
  i2c_cmd(0xA5, 0, 0);
}

void cfg_normal( void )
{
  char para[4];

  // 设置驱动的路数，0.91寸的显示屏最大好像是32
  para[0] = 0x20;
  i2c_cmd(0XA8, para, 1);

  // 不管显示内存RAM的内容，直接打开整个显示
  i2c_cmd(0xA4, 0, 0);
}

void oled_ssd1306_init( void )
{
  delay(1000);
  // 关闭显示
  i2c_cmd(0xAE, 0, 0);

  //cfg_all_on();
  cfg_normal();

  // 打开显示
  i2c_cmd(0XAF, 0, 0);

  ssd1306_clear(0x80);
  //ssd1306_draw_char(0, 0, '0');
  ssd1306_draw_text2(0, 0, "74.5kg", 6);
}

