#include "oled_ssd1306.h"
#include "sl_i2cspm_instances.h"


#define OLED_I2C_ADDRESS                                         0X78


void delay(int x)
{
  int i, j;

  for (i = 0; i < x; i++)
    for (j = 0; j < 1000; j++) ;
}


/* cmd: 命令
 * para: 参数
 * len : 参数字节数
 */
int i2c_cmd(char cmd, char* para, char len)
{
  uint8_t i, bytes[10], ctl[] = {0};
  I2C_TransferSeq_TypeDef seq = {
      .addr  = OLED_I2C_ADDRESS,
      .flags = I2C_FLAG_WRITE_WRITE,
      .buf   = {
          {.data = ctl,   .len = 1},
          {.data = bytes, .len = 1+len}
      }
  };

  bytes[0] = cmd;
  for (i = 0; i < len; i++)
    bytes[i+1] = para[i];

  return (int)I2CSPM_Transfer(sl_i2cspm_oled_i2c, &seq);
}

int i2c_data(char dat)
{
  uint8_t ctl[] = {0x40}, bytes[] = {0};
  I2C_TransferSeq_TypeDef seq = {
      .addr  = OLED_I2C_ADDRESS,
      .flags = I2C_FLAG_WRITE_WRITE,
      .buf   = {
          {.data = ctl,   .len = 1},
          {.data = bytes, .len = 1}
      }
  };

  bytes[0] = dat;
  return (int)I2CSPM_Transfer(sl_i2cspm_oled_i2c, &seq);
}


void ssd1306_clear(unsigned char val)
{
  int i, j;

  for (i = 0; i < 8; i++) // page
  {
      i2c_cmd(0xb0+i, 0, 0);  // 设置页地址
      i2c_cmd(0x00, 0, 0);
      i2c_cmd(0x10, 0, 0);

      for (j = 0; j < 128; j++)
        i2c_data(val);
  }
}

void ssd1306_set_pos(char x, char y)
{
  i2c_cmd(0xb0+y, 0, 0);  // 设置页地址
  i2c_cmd(0x10 + ((x>>4)&0x0f), 0, 0);
  i2c_cmd(0x00 + (x&0x0f), 0, 0);
}

unsigned char font8x16[][16] =
{
  {0x00,0xC0,0x30,0x10,0x10,0x30,0xE0,0x00,0x00,0x07,0x0C,0x08,0x08,0x0C,0x03,0x00},/*"0",0*/
  {0x00,0x20,0x20,0x10,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00},/*"1",1*/
  {0x00,0x20,0x10,0x10,0x10,0x90,0xE0,0x00,0x00,0x0C,0x0A,0x0A,0x09,0x08,0x08,0x00},/*"2",2*/
  {0x00,0x20,0x90,0x90,0x90,0x60,0x00,0x00,0x00,0x04,0x08,0x08,0x08,0x07,0x00,0x00},/*"3",3*/
  {0x00,0x00,0x80,0x40,0x20,0xF0,0x00,0x00,0x02,0x03,0x02,0x02,0x02,0x0F,0x02,0x00},/*"4",4*/
  {0x00,0xF0,0x90,0x90,0x90,0x90,0x10,0x00,0x00,0x00,0x08,0x08,0x08,0x0D,0x07,0x00},/*"5",5*/
  {0x00,0xC0,0x20,0x90,0x90,0x90,0x00,0x00,0x00,0x07,0x0D,0x08,0x08,0x08,0x07,0x00},/*"6",6*/
  {0x10,0x10,0x10,0x10,0x90,0x70,0x10,0x00,0x00,0x00,0x0C,0x03,0x00,0x00,0x00,0x00},/*"7",7*/
  {0x00,0x60,0x90,0x90,0x90,0x90,0x60,0x00,0x00,0x07,0x08,0x08,0x08,0x08,0x07,0x00},/*"8",8*/
  {0x00,0xE0,0x10,0x10,0x10,0x30,0xE0,0x00,0x00,0x00,0x09,0x09,0x09,0x05,0x03,0x00},/*"9",9*/
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x00,0x00,0x00,0x00,0x00},/*".",10*/
  {0x00,0xF0,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x0F,0x02,0x05,0x0D,0x08,0x00,0x00},/*"k",11*/
  {0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x07,0x28,0x28,0x28,0x28,0x1F,0x00},/*"g",12*/
};

void ssd1306_draw_char(char x, char y, char ch)
{
  int i, idx;

  if ((ch >= '0') && (ch <= '9')) idx = ch - '0';
  else if (ch == '.') idx = 10;
  else if (ch == 'k') idx = 11;
  else if (ch == 'g') idx = 12;
  else return ;

  ssd1306_set_pos(x, y);
  for (i = 0; i < 8; i++)
    i2c_data(font8x16[idx][i]);
  ssd1306_set_pos(x, y + 1);
  for (i = 0; i < 8; i++)
    i2c_data(font8x16[idx][i+8]);
}

void ssd1306_draw_text(char x, char y, char* str, char len)
{
  int i;

  for (i = 0; i < len; i++)
    ssd1306_draw_char(x + i*8, y, str[i]);
}

unsigned char font16x32[][32] =
{
    {0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xF8,0xFE,0x07,0x01,0x00,0x00,0x00,0x00,0x01,0x0F,0xFE,0xF0,0x00,0x00},
    {0x00,0x0F,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x0C,0x08,0x08,0x08,0x08,0x06,0x07,0x01,0x00,0x00,0x00},/*"0",0*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x0F,0x0F,0x08,0x08,0x08,0x08,0x00,0x00,0x00},/*"1",1*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x1E,0x3F,0x10,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0x7F,0x1C,0x00,0x00},
    {0x00,0x00,0x00,0x00,0xC0,0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00,0x80,0x00,0x00,0x00,0x0C,0x0E,0x0D,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0E,0x01,0x00,0x00},/*"2",2*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x0F,0x08,0x00,0x00,0x00,0x00,0x80,0xC3,0x7F,0x3E,0x00,0x00,0x00},
    {0x00,0x00,0x80,0xC0,0x80,0x00,0x01,0x01,0x01,0x02,0x02,0x1C,0xFC,0xF0,0x00,0x00,0x00,0x00,0x03,0x07,0x0D,0x08,0x08,0x08,0x08,0x08,0x0C,0x07,0x03,0x00,0x00,0x00},/*"3",3*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x30,0x08,0x06,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x30,0x2C,0x26,0x21,0x20,0x20,0x20,0x20,0xFF,0xFF,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x0F,0x0F,0x0C,0x08,0x08,0x00,0x00},/*"4",4*/
    {0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x01,0x81,0x81,0xC1,0xC1,0xC1,0x81,0x81,0x01,0x00,0x00,0x00},
    {0x00,0x00,0xC0,0xC3,0x81,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0xFF,0xFC,0x00,0x00,0x00,0x00,0x03,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x0C,0x07,0x03,0x00,0x00,0x00},/*"5",5*/
    {0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0x07,0x81,0x80,0xC0,0xC0,0xC0,0x80,0x87,0x03,0x00,0x00,0x00},
    {0x00,0x1F,0xFF,0xFF,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFE,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0C,0x08,0x08,0x08,0x08,0x08,0x06,0x03,0x01,0x00,0x00},/*"6",6*/
    {0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x0F,0x03,0x01,0x01,0x01,0x01,0x01,0xC1,0x31,0x0D,0x03,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0x0F,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"7",7*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x7F,0xE1,0xC0,0x80,0x80,0x00,0x00,0x80,0xC1,0x7F,0x1C,0x00,0x00},
    {0x00,0xE0,0xF8,0x0C,0x06,0x03,0x01,0x03,0x03,0x07,0x0E,0x1C,0xF8,0xF0,0x00,0x00,0x00,0x00,0x03,0x06,0x0C,0x08,0x08,0x08,0x08,0x08,0x08,0x04,0x03,0x01,0x00,0x00},/*"8",8*/
    {0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0x8F,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x87,0xFE,0xF8,0x00,0x00},
    {0x00,0x00,0x03,0x07,0x0C,0x0C,0x08,0x08,0x08,0x04,0x02,0xF1,0xFF,0x1F,0x00,0x00,0x00,0x00,0x02,0x07,0x0F,0x08,0x08,0x08,0x08,0x04,0x07,0x03,0x00,0x00,0x00,0x00},/*"9",9*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x0E,0x0E,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*".",10*/
    {0x00,0x00,0x80,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x40,0xC0,0x40,0x40,0x40,0x00,0x00},
    {0x00,0x00,0x00,0xFF,0xFF,0x30,0x18,0x1C,0x7E,0xE3,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x0F,0x0F,0x08,0x00,0x00,0x00,0x00,0x0B,0x0F,0x0C,0x08,0x08,0x00},/*"k",11*/
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x40,0x40,0x40,0x40,0x80,0x80,0x40,0xC0,0xC0,0x00},
    {0x00,0x00,0x00,0x9F,0x71,0x40,0x40,0x40,0x40,0x40,0x31,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0xCF,0x87,0x02,0x06,0x06,0x06,0x06,0x06,0x84,0xFC,0x78,0x00,0x00},/*"g",12*/
};

void ssd1306_draw_char2(char x, char y, char ch)
{
  int i, j, idx;

  if ((ch >= '0') && (ch <= '9')) idx = (ch - '0') * 2;
  else if (ch == '.') idx = 20;
  else if (ch == 'k') idx = 22;
  else if (ch == 'g') idx = 24;
  else return ;

  for (i = 0; i < 4; i++)
  {
      ssd1306_set_pos(x, y + i);
      for (j = 0; j < 16; j++)
      {
          int ridx = i / 2;
          int hidx = i % 2;
          i2c_data(font16x32[idx + ridx][hidx*16 + j]);
      }
  }
}

void ssd1306_draw_text2(char x, char y, char* str, char len)
{
  int i;

  for (i = 0; i < len; i++)
    ssd1306_draw_char2(x + i*16, y, str[i]);
}

// 用于测试图像显示
const unsigned char bluetooth_triangle[128] = { /* 0X21,0X01,0X20,0X00,0X20,0X00, */
    0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
    0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0XF8,0XFF,0XFF,0X1F,
    0XFC,0XFF,0XFF,0X3F,0XFC,0XFF,0XFF,0X3F,0XFC,0XFF,0XFF,0X3F,0XF8,0XFF,0XFF,0X1F,
    0XF0,0XFF,0XFF,0X0F,0XF0,0XFF,0XFF,0X0F,0XE0,0XFF,0XFF,0X07,0XC0,0XFF,0XFF,0X03,
    0XC0,0XFF,0XFF,0X03,0X80,0XFF,0XFF,0X01,0X00,0XFF,0XFF,0X00,0X00,0XFF,0X7F,0X00,
    0X00,0XFE,0X7F,0X00,0X00,0XFC,0X3F,0X00,0X00,0XF8,0X1F,0X00,0X00,0XF8,0X1F,0X00,
    0X00,0XF0,0X0F,0X00,0X00,0XE0,0X07,0X00,0X00,0XE0,0X07,0X00,0X00,0X80,0X01,0X00,
    0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
};

const unsigned char bluetooth_icon[128] = { /* 0X21,0X01,0X20,0X00,0X20,0X00, */
    0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
    0X00,0XFC,0X3F,0X00,0X80,0XFF,0XFF,0X01,0XE0,0XFF,0XFF,0X0F,0XF8,0XFF,0XFF,0X1F,
    0XFC,0XFF,0XFF,0X3F,0XFC,0XFB,0XBF,0X7F,0XFE,0XF1,0X1F,0X7F,0XFE,0XE1,0X8F,0X7F,
    0XFE,0XC3,0XC7,0X7F,0XFF,0X87,0XE3,0XFF,0XFF,0X0F,0XF1,0XFF,0X07,0X00,0X00,0XC0,
    0X0F,0X00,0X00,0XE0,0X1F,0X1C,0XF8,0XF0,0X3F,0X0E,0XF1,0XF8,0X7F,0X8C,0X63,0XFC,
    0XFE,0XE0,0X07,0X7E,0XFE,0XF1,0X0F,0X7F,0XFE,0XFB,0X9F,0X7F,0XFC,0XFF,0XFF,0X3F,
    0XF8,0XFF,0XFF,0X1F,0XF0,0XFF,0XFF,0X0F,0XC0,0XFF,0XFF,0X03,0X00,0XFC,0X3F,0X00,
    0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
};

void ssd1306_draw_bmp(char x, char y, char w, char h, const unsigned char* bmp)
{
  int i, j, p;

  p = h / 8; // 32/8 = 4
  for (i = 0; i < p; i++)
  {
      ssd1306_set_pos(x, y + i);
      for (j = 0; j < w; j++)
      {
          int idx = p*j + i;
          i2c_data(bmp[idx]);
      }
  }
}

/* 1. 配置驱动的行数
 * 2. 测试打开整个显示屏
 * */
void cfg_all_on( void )
{
  char para[4];

  // 设置驱动的路数，0.91寸的显示屏最大好像是32
  para[0] = 0x20;
  i2c_cmd(0XA8, para, 1);

  // 不管显示内存RAM的内容，直接打开整个显示
  i2c_cmd(0xA5, 0, 0);
}

void cfg_normal( void )
{
  char para[4];

  // 设置显示起始行（RESET后设置为0）
  i2c_cmd(0x40, 0, 0);
  // 设置页寻址模式的页（page）起始地址
  i2c_cmd(0xb0, 0, 0);

  // 设置COM输出扫描方向
  i2c_cmd(0xc8, 0, 0);
  // 设置对赌控制
  para[0] = 0xff;
  i2c_cmd(0x81, para, 1);
  // 设置段（segment）重映射
  i2c_cmd(0xa1, 0, 0);
  // 设置正常/翻转显示
  i2c_cmd(0xa6, 0, 0);

  // 设置驱动的路数，0.91寸的显示屏最大好像是32
  para[0] = 0x1f;
  i2c_cmd(0xa8, para, 1);
  // 设置显示偏移
  para[0] = 0x00;
  i2c_cmd(0xd3, para, 1);
  // 设置显示时钟的分频系数（RESET为1000b）
  para[0] = 0xf0;
  i2c_cmd(0xd5, para, 1);
  // 设置预充（pre-charge）电周期
  para[0] = 0x22;
  i2c_cmd(0xd9, para, 1);

  // 设置COM管脚硬件配置
  para[0] = 0x02;
  i2c_cmd(0xda, para, 1);

  // 调整VCOMH电压
  para[0] = 0x49;
  i2c_cmd(0xdb, para, 10);

  i2c_cmd(0x8d, 0, 0);
  i2c_cmd(0x14, 0, 0);

  // 不管显示内存RAM的内容，直接打开整个显示
  //i2c_cmd(0xA4, 0, 0);
}

void oled_ssd1306_init( void )
{
  delay(1000);
  // 关闭显示
  i2c_cmd(0xAE, 0, 0);

  //cfg_all_on();
  cfg_normal();

  // 打开显示
  i2c_cmd(0XAF, 0, 0);

  ssd1306_clear(0x80);
  //ssd1306_draw_char(0, 0, '0');
  ssd1306_draw_text2(0, 0, "74.5kg", 6);

  ssd1306_draw_bmp(16, 0, 32, 32, bluetooth_icon);
}

void oled_test( void )
{
  static int cnt = 0;

  cnt++;

  if (cnt % 100 == 0)
  {
      char str[] = "000";
      int t = (cnt / 100) % 10;
      str[0] = '0'+t;
      ssd1306_draw_text2(80, 0, str, 3);
  }
}
